package org.haoxiangzuo.hw3;

import org.haoxiangzuo.hw6.client.ChessService;
import org.haoxiangzuo.hw6.client.ChessServiceAsync;
import org.haoxiangzuo.hw6.client.UserInfos;

import com.google.gwt.appengine.channel.client.ChannelError;
import com.google.gwt.appengine.channel.client.ChannelFactoryImpl;
import com.google.gwt.appengine.channel.client.Socket;
import com.google.gwt.appengine.channel.client.SocketListener;
import com.google.gwt.core.client.EntryPoint;
import com.google.gwt.core.client.GWT;
import com.google.gwt.event.logical.shared.ValueChangeEvent;
import com.google.gwt.event.logical.shared.ValueChangeHandler;
import com.google.gwt.user.client.History;
import com.google.gwt.user.client.Window;
import com.google.gwt.user.client.rpc.AsyncCallback;
import com.google.gwt.user.client.ui.Anchor;
import com.google.gwt.user.client.ui.Button;
import com.google.gwt.user.client.ui.HorizontalPanel;
import com.google.gwt.user.client.ui.Label;
import com.google.gwt.user.client.ui.ListBox;
import com.google.gwt.user.client.ui.RootPanel;
import com.google.gwt.user.client.ui.TextBox;
import com.google.gwt.user.client.ui.VerticalPanel;

public class ChessEntryPoint implements EntryPoint {
	HorizontalPanel loginPanel = new HorizontalPanel();
	Label loginStatus = new Label("Please Sign in with your google account");
	Anchor login = new Anchor("sign in");
	
	UserInfos currentUser = null;
	final Graphics graphics = new Graphics();
	Socket socket = null;
	@Override
	public void onModuleLoad() {
		// TODO Auto-generated method stub
		ChessServiceAsync services = GWT.create(ChessService.class);
		  services.login(GWT.getHostPageBaseURL()+"haoxiangzuo.html", new AsyncCallback<UserInfos>(){

			@Override
			public void onFailure(Throwable caught) {
				// TODO Auto-generated method stub
				Window.alert("Connection error");
			}

			@Override
			public void onSuccess(UserInfos result) {
				// TODO Auto-generated method stub
				if (!result.isLoggedIn())
				{
					loginPanel.add(loginStatus);
					login.setHref(result.getLoginUrl());
					loginPanel.add(login);
					RootPanel.get().add(loginPanel);
				}
				else
				{
					currentUser = result;
					play();
				}
			}});
	}
	public void play()
	  {
		  graphics.setUser(currentUser);
		  RootPanel.get().add(graphics);
//		  History.addValueChangeHandler(new ValueChangeHandler<String>()
//			  {
//
//				@Override
//				public void onValueChange(ValueChangeEvent<String> event) {
//					// TODO Auto-generated method stub
//					String historyToken = event.getValue();
//
//					if (!History.getToken().isEmpty())
//						graphics.callHistoryChanger(historyToken.substring(4));
//					
//				}});
	  }
}

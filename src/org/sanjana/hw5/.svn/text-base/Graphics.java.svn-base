package org.sanjana.hw5;

import static org.shared.chess.Color.BLACK;
import static org.shared.chess.Color.WHITE;
import static org.shared.chess.GameResultReason.CHECKMATE;
import static org.shared.chess.GameResultReason.FIFTY_MOVE_RULE;
import static org.shared.chess.GameResultReason.STALEMATE;

import org.sanjana.hw5.Presenter.View;
import org.sanjana.hw6.ChessService;
import org.sanjana.hw6.ChessServiceAsync;
import org.sanjana.hw6.LoginDetails;
import org.sanjana.hw6.StateManager;
import org.shared.chess.Color;
import org.shared.chess.GameResult;
import org.shared.chess.Piece;
import org.shared.chess.State;

import com.google.gwt.appengine.channel.client.Channel;
import com.google.gwt.appengine.channel.client.ChannelError;
import com.google.gwt.appengine.channel.client.ChannelFactoryImpl;
import com.google.gwt.appengine.channel.client.SocketListener;
import com.google.gwt.core.shared.GWT;
import com.google.gwt.event.dom.client.ClickEvent;
import com.google.gwt.event.dom.client.ClickHandler;
import com.google.gwt.event.dom.client.DragOverEvent;
import com.google.gwt.event.dom.client.DragOverHandler;
import com.google.gwt.event.dom.client.DragStartEvent;
import com.google.gwt.event.dom.client.DragStartHandler;
import com.google.gwt.event.dom.client.DropEvent;
import com.google.gwt.event.dom.client.DropHandler;
import com.google.gwt.event.dom.client.HasClickHandlers;
import com.google.gwt.event.logical.shared.ValueChangeEvent;
import com.google.gwt.event.logical.shared.ValueChangeHandler;
import com.google.gwt.storage.client.Storage;
import com.google.gwt.uibinder.client.UiBinder;
import com.google.gwt.uibinder.client.UiField;
import com.google.gwt.user.client.Element;
import com.google.gwt.user.client.History;
import com.google.gwt.user.client.Window;
import com.google.gwt.user.client.rpc.AsyncCallback;
import com.google.gwt.user.client.ui.Button;
import com.google.gwt.user.client.ui.CheckBox;
import com.google.gwt.user.client.ui.Composite;
import com.google.gwt.user.client.ui.FlexTable;
import com.google.gwt.user.client.ui.Grid;
import com.google.gwt.user.client.ui.Image;
import com.google.gwt.user.client.ui.Label;
import com.google.gwt.user.client.ui.TextBox;
import com.google.gwt.user.client.ui.Widget;

public class Graphics extends Composite implements View 
{	
	private static GameImages gameImages = GWT.create(GameImages.class);
	private static GraphicsUiBinder uiBinder = GWT.create(GraphicsUiBinder.class);

	interface GraphicsUiBinder extends UiBinder<Widget, Graphics> {	}

	@UiField GameCss css;
	@UiField Label gameStatus;
	@UiField Grid gameGrid;
	@UiField Grid whitepromotionGrid;
	@UiField Grid blackpromotionGrid;
	@UiField Grid controlGrid;
	@UiField Button LoadButton;
	@UiField Button ClearButton;
	@UiField Button SaveButton;
	@UiField TextBox saveStatus;
	@UiField FlexTable flexTable;
	@UiField Label playerTurn;
	@UiField Label opponentTurn;

	public Presenter presenter;
	int index=0;
	State state;

	//History
	String historyToken;

	//	public ChessServiceAsync chessService=GWT.create(ChessService.class);
	LoginDetails player=null;
	private boolean canPlay=false;
	private Color turn;

	private Image[][] board = new Image[8][8];
	private Image[] whitepromotionImages = new Image[4];
	private Image[] blackpromotionImages = new Image[4];

	public Graphics(final Presenter presenter) 
	{
		initWidget(uiBinder.createAndBindUi(this));
		gameGrid.resize(8, 8);
		gameGrid.setCellPadding(0);
		gameGrid.setCellSpacing(0);
		gameGrid.setBorderWidth(0);

		for (int row = 0; row < 8; row++) 
		{
			for (int col = 0; col < 8; col++) 
			{
				final Image image = new Image();
				board[row][col] = image;
				image.setWidth("100%");
				image.setResource(gameImages.emptyTile());
				gameGrid.setWidget(row, col, image);
			}
		}

		this.presenter = presenter;
		whitepromotionGrid.resize(1, 4);
		blackpromotionGrid.resize(1, 4);
		controlGrid.resize(1, 3);
		controlGrid.setCellPadding(0);
		controlGrid.setCellSpacing(0);
		controlGrid.setBorderWidth(0);
		setwhitePromotionGrid();
		setblackPromotionGrid();
		init();
	}

	public void init()
	{
		initBoardHandlers();
		initPromotionHandlers();
		initStorageHandlers();
		initControlHandler();
	}

	@Override
	public void setPiece(int row, int col, Piece piece)
	{
		if (piece != null)
		{	
			switch(piece.getKind())
			{
			case PAWN:
				if(piece.getColor()==WHITE)
					board[row][col].setResource(gameImages.whitePawn());
				else
					board[row][col].setResource(gameImages.blackPawn());
				break;

			case BISHOP:
				if(piece.getColor()==WHITE)
					board[row][col].setResource(gameImages.whiteBishop());
				else
					board[row][col].setResource(gameImages.blackBishop());
				break;

			case ROOK:
				if(piece.getColor()==WHITE)
					board[row][col].setResource(gameImages.whiteRook());
				else
					board[row][col].setResource(gameImages.blackRook());
				break;

			case KNIGHT:
				if(piece.getColor()==WHITE)
					board[row][col].setResource(gameImages.whiteKnight());
				else
					board[row][col].setResource(gameImages.blackKnight());
				break;

			case KING:
				if(piece.getColor()==WHITE)
					board[row][col].setResource(gameImages.whiteKing());
				else
					board[row][col].setResource(gameImages.blackKing());
				break;

			case QUEEN:
				if(piece.getColor()==WHITE)
					board[row][col].setResource(gameImages.whiteQueen());
				else
					board[row][col].setResource(gameImages.blackQueen());
				break;

			default:
				break;
			}
			gameGrid.setWidget(row, col, board[row][col]);
		}

		else
		{		
			board[row][col].setResource(gameImages.emptyTile());
			gameGrid.setWidget(row, col, board[row][col]);
		}
	}

	@Override
	public void setWhoseTurn(Color color) {
		if(color==WHITE)
			gameStatus.setText("The current turn in the Game is of White");
		else
			gameStatus.setText("The current turn in the Game is of Black");
	}

	@Override
	public void setPlayerTurn(Color color){
		if(color==WHITE)
			playerTurn.setText("You are playing as : WHITE");
		else
			playerTurn.setText("You are playing as : BLACK");
	}

	@Override
	public void setOpponentTurn(Color color){
		if(color==WHITE)
			opponentTurn.setText("Opponent is playing as: WHITE");
		else
			opponentTurn.setText("Opponent is playing as: BLACK");
	}

	@Override 
	public void setTurn(Color turn){
		this.turn=turn;
	}

	@Override
	public void setHighlighted(int row, int col, boolean highlighted) 
	{
		Element element = board[row][col].getElement();
		if (highlighted) 
			element.setClassName(css.highlighted());
		else 
			element.removeClassName(css.highlighted());
	}

	@Override
	public void setGameResult(GameResult gameResult) 
	{
		if (gameResult == null)
			return;

		if(gameResult.getGameResultReason()!=STALEMATE)
		{
			if(gameResult.getGameResultReason()==CHECKMATE)
			{
				if(gameResult.getWinner()==BLACK)
					gameStatus.setText("Black Wins, White is CheckMated!");
				else if(gameResult.getWinner()==WHITE)
					gameStatus.setText("White Wins, Black is Checkmated!");
			}

			if(gameResult.getGameResultReason()==FIFTY_MOVE_RULE)
			{
				if(gameResult.getWinner()==BLACK)
					gameStatus.setText("Black Wins, 50 MoveRule!");
				else if(gameResult.getWinner()==WHITE)
					gameStatus.setText("White Wins, 50 MoveRule!");
			}
		}

		else if(gameResult.getGameResultReason()==STALEMATE)
			gameStatus.setText("Stalemate, No One Wins.!");

		else 			
			gameStatus.setText("Unknown game over state!");
	}

	@Override
	public void setPromotionGridVisible(Color c,boolean show) 
	{
		if(c==WHITE)
			whitepromotionGrid.setVisible(show);
		else
			blackpromotionGrid.setVisible(show);
	}

	@Override
	public void setwhitePromotionGrid() 
	{
		whitepromotionImages[0]=new Image(gameImages.whiteKnight());
		whitepromotionImages[1]=new Image(gameImages.whiteBishop());
		whitepromotionImages[2]=new Image(gameImages.whiteRook());
		whitepromotionImages[3]=new Image(gameImages.whiteQueen());	
		for(int i=0;i<4;i++)
			whitepromotionGrid.setWidget(0, i, whitepromotionImages[i]);
	}

	@Override
	public void setblackPromotionGrid() 
	{
		blackpromotionImages[0]=new Image(gameImages.blackKnight());
		blackpromotionImages[1]=new Image(gameImages.blackBishop());
		blackpromotionImages[2]=new Image(gameImages.blackRook());
		blackpromotionImages[3]=new Image(gameImages.blackQueen());	
		for(int i=0;i<4;i++)
			blackpromotionGrid.setWidget(0, i, blackpromotionImages[i]);
	}

	@Override
	public HasClickHandlers getImage(int row, int col) {
		return board[row][col];
	}

	@Override
	public Element getElement(int x, int y){
		return board[x][y].getElement();
	}

	@Override
	public void setDisableStorageButtons() 
	{
		SaveButton.setVisible(false);
		LoadButton.setVisible(false);
	}

	@Override
	public HasClickHandlers getPromotionImage(Color c,int index) 
	{
		if(c==WHITE)
			return whitepromotionImages[index];
		else
			return blackpromotionImages[index];
	}

	@Override
	public void initPromotionHandlers() 
	{
		for (int i = 0; i < 4; i++) 
		{
			final int index = i;
			getPromotionImage(WHITE,i).addClickHandler(new ClickHandler(){
				@Override
				public void onClick(ClickEvent event){
					if(canPlay)
						presenter.setPromotion(index);
				}
			});

			getPromotionImage(BLACK,i).addClickHandler(new ClickHandler(){
				@Override
				public void onClick(ClickEvent event){
					if(canPlay)
						presenter.setPromotion(index);
				}
			});
		}
		setPromotionGridVisible(WHITE,false);
		setPromotionGridVisible(BLACK,false);
	}

	/**
	 * Setting handlers for board
	 */
	@Override
	public void initBoardHandlers() 
	{		
		for (int row = 0; row < 8; row++) 
		{
			for (int col = 0; col < 8; col++) 
			{
				final int r = 7 - row;
				final int c = col;
				getImage(row, col).addClickHandler(new ClickHandler(){
					@Override
					public void onClick(ClickEvent event)
					{
						if(!presenter.getsoundCheck())
							presenter.Sounds.playClick();
						presenter.onClicked(r, c);
					}
				});
			}
		}

		History.addValueChangeHandler(new ValueChangeHandler<String>() {
			@Override
			public void onValueChange(ValueChangeEvent<String> event) {
				String historyToken = event.getValue();
				presenter.setHistory(historyToken);
			}
		});
	}

	public void manageHistory(String token) {
		presenter.setHistory(token);
	}

	@Override
	public void initStorageHandlers() 
	{
		flexTable.setWidget(0, 0, new Label("Name of saved Games"));
		final Storage stockStore=Storage.getLocalStorageIfSupported();

		if(stockStore==null)
		{
			setDisableStorageButtons();
			Window.alert("Your browser does not support local storage!");
		}
		stockStore.clear();

		SaveButton.addClickHandler(new ClickHandler() {
			@Override
			public void onClick(ClickEvent event) {
				if(stockStore!=null)
				{
					if (stockStore.getItem(saveStatus.getText())==null)
						flexTable.setWidget(flexTable.getRowCount(), 0, new Label(saveStatus.getText()));

					String save=presenter.addStorage(saveStatus.getText());
					stockStore.setItem(saveStatus.getText(), save);
					LoadButton.setVisible(true);
				}
			}
		});

		LoadButton.addClickHandler(new ClickHandler() {
			@Override
			public void onClick(ClickEvent event) {
				if(stockStore!=null)
				{
					final String value = stockStore.getItem(saveStatus.getText());
					if(value != null)
						presenter.loadStorage(value);
					else
						presenter.showStartingPositions(state);
				}
			}
		});

		ClearButton.addClickHandler(new ClickHandler() {
			@Override
			public void onClick(ClickEvent event) {
				if(stockStore!=null)
				{
					stockStore.clear();
					flexTable.clear();
					flexTable.setWidget(flexTable.getRowCount(), 0, new Label("Name of saved Games"));
				}
			}
		});
		LoadButton.setVisible(false);
	}

	@Override
	public void initControlHandler()
	{
		CheckBox animationFlag = new CheckBox("Disable Animation");
		CheckBox soundFlag = new CheckBox("Disable Sound");

		Button restartButton=new Button();
		restartButton.setText("Start New Game");
		restartButton.addClickHandler(new ClickHandler() {
			@Override
			public void onClick(ClickEvent event) 
			{
				presenter.restartClicked();
				initStorageHandlers();
			}
		});
		controlGrid.setWidget(0, 0, restartButton);

		animationFlag.addClickHandler(new ClickHandler(){
			@Override
			public void onClick(ClickEvent event)
			{
				boolean checked = ((CheckBox) event.getSource()).getValue();
				presenter.animationDisable(checked);
			}
		});

		controlGrid.setWidget(0, 1, animationFlag);
		soundFlag.addClickHandler(new ClickHandler(){
			@Override
			public void onClick(ClickEvent event)
			{
				boolean checked =((CheckBox) event.getSource()).getValue();
				presenter.soundDisable(checked);
			}
		});
		controlGrid.setWidget(0,2, soundFlag);

		if(!presenter.getanimationCheck())
			initAnimationHandler();
	}

	@Override
	public void initAnimationHandler()
	{
		for (int row = 0; row < 8; row++) 
		{
			for (int col = 0; col < 8; col++) 
			{
				final int r = 7 - row;
				final int c = col;

				final Image image = board[row][col];
				image.getElement().setDraggable(Element.DRAGGABLE_TRUE);	
				image.addDragStartHandler(new DragStartHandler(){
					@Override
					public void onDragStart(DragStartEvent event)
					{
						event.setData("text", "Hello World");
						event.getDataTransfer().setDragImage(image.getElement(),0, 0);
						if(canPlay)
							presenter.onClicked(r,c);
					}
				});

				image.addDragOverHandler(new DragOverHandler(){
					@Override
					public void onDragOver(DragOverEvent event) 
					{
						event.getDataTransfer().setDragImage(image.getElement(),
								event.getNativeEvent().getClientX(),
								event.getNativeEvent().getClientY());
						image.getElement().getStyle().clearBackgroundColor();					
					}
				});

				image.addDropHandler(new DropHandler(){
					@Override
					public void onDrop(DropEvent event) 
					{
						event.preventDefault();
						if(canPlay)
							presenter.onClicked(r,c);
					}
				});
			}
		}	
	}

	/*
	 *  Channel Initialization after a player logs in.
	 */
	public void initStateWithChannel(final LoginDetails player)
	{
		this.player=player;

		//Channel
		Channel channel = new ChannelFactoryImpl().createChannel(player.getToken());
		channel.open(new SocketListener() {

			@Override
			public void onOpen() {

//				Window.alert("Channel opened.");
				if(player.getPlayerColor()==WHITE)
				{
					Window.alert("Waiting for the other player to Join in, Please be patient! Thank you ");
					canPlay=false;
				}
				setPlayerTurn(player.getPlayerColor());
				setOpponentTurn(player.getPlayerColor().getOpposite());
				canPlay=false;
				//
				//				else
				//					Window.alert("Other player has joined in. Best of Luck!");
			}

			@Override
			public void onMessage(String message) {
				//					Window.alert("Received: " + message);
				//						State state=stateRecord.get(result);
				if(message.equals("start"))
				{
					Window.alert("Other player has joined in. Best of Luck!");
					canPlay=true;
					//					setPlayerTurn(player.getPlayerColor());
					//					setOpponentTurn(player.getPlayerColor().getOpposite());
				}
				else
				{
					canPlay=true;
					//					setPlayerTurn(player.getPlayerColor());
					//					setOpponentTurn(player.getPlayerColor().getOpposite());
					State state=StateSerializer.deserialize(message);
					presenter.setState(state);
					//					presenter.showStartingPositions(state);
				}
			}

			@Override
			public void onError(ChannelError error) {
				System.out.println("Channel error: " + error.getCode() + " : "
						+ error.getDescription());
			}

			@Override
			public void onClose() {
				System.out.println("Channel closed!");
			}
		});
	}

	/*
	 * Sends move to the server. 
	 * (non-Javadoc)
	 * @see org.sanjana.hw5.Presenter.View#updateMove(org.shared.chess.State)
	 */

	@Override
	public void updateMove(State state)
	{		
		//		if (chessService == null) 
		ChessServiceAsync chessService = GWT.create(ChessService.class);

		StateManager update=new StateManager();
		update.setState(StateSerializer.serialize(state));
		update.setGameId(player.getBoardId());
		update.setTurn(turn);
		canPlay=false;

		chessService.update(update, new AsyncCallback<String>(){

			@Override
			public void onFailure(Throwable caught) {
				Window.alert("Async failed");
			}

			@Override
			public void onSuccess(String result) {
				//				Window.alert("Async success");
			}
		});	
	}
}

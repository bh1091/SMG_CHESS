package org.shihweihuang.hw3;

import java.util.Set;

import org.shared.chess.Color;
import org.shared.chess.Piece;
import org.shared.chess.State;
import org.shihweihuang.hw6.client.ChessPlatformService;
import org.shihweihuang.hw6.client.ChessPlatformServiceAsync;
import org.shihweihuang.hw6.client.LoginInfo;
import org.shihweihuang.hw6.client.LoginService;
import org.shihweihuang.hw6.client.LoginServiceAsync;
import org.shihweihuang.hw7.Match;
import org.shihweihuang.hw8.MyMessage;

import com.google.gwt.appengine.channel.client.Channel;
import com.google.gwt.appengine.channel.client.ChannelError;
import com.google.gwt.appengine.channel.client.ChannelFactoryImpl;
import com.google.gwt.appengine.channel.client.Socket;
import com.google.gwt.appengine.channel.client.SocketListener;
import com.google.gwt.core.client.EntryPoint;
import com.google.gwt.core.client.GWT;
import com.google.gwt.event.dom.client.ChangeEvent;
import com.google.gwt.event.dom.client.ChangeHandler;
import com.google.gwt.event.dom.client.ClickEvent;
import com.google.gwt.event.dom.client.ClickHandler;
import com.google.gwt.user.client.Window;
import com.google.gwt.user.client.rpc.AsyncCallback;
import com.google.gwt.user.client.ui.Anchor;
import com.google.gwt.user.client.ui.Button;
import com.google.gwt.user.client.ui.HorizontalPanel;
import com.google.gwt.user.client.ui.Label;
import com.google.gwt.user.client.ui.ListBox;
import com.google.gwt.user.client.ui.Panel;
import com.google.gwt.user.client.ui.RootPanel;
import com.google.gwt.user.client.ui.TextBox;

public class ChessEntryPoint implements EntryPoint {
	String url;
	String token;
	Anchor languageSelector = new Anchor();
	Button connectButton = new Button();
	Button removeMatchButton = new Button();
	Button autoMatchButton = new Button();
	Button singlePlayerButton = new Button();
	TextBox matchRequestName = new TextBox();
	Label connectLabel = new Label();
	Panel connectPanel = new HorizontalPanel();
	Panel matchPanel = new HorizontalPanel();
	ListBox matchListBox = new ListBox();
	Socket socket;
	boolean isConnect = false;
	Presenter presenter;
	LoginInfo loginInfo;
	double ranking;
	State emptyState = new State(Color.WHITE, new Piece[8][8], new boolean[] {
			true, true }, new boolean[] { true, true }, null, 0, null);
	ChessPlatformServiceAsync chessPlatformService = GWT
			.create(ChessPlatformService.class);
	MyMessage messages = (MyMessage) GWT.create(MyMessage.class);

	public void onModuleLoad() {
		connectLabel.setText(messages.enterEmail());
		connectPanel.add(connectLabel);
		connectPanel.add(matchRequestName);
		connectPanel.add(connectButton);
		connectPanel.add(autoMatchButton);
		connectButton.setText(messages.match());
		matchPanel.add(matchListBox);
		matchPanel.add(removeMatchButton);
		languageSelector.setText(messages.language());
		singlePlayerButton.setText(messages.singlePlayer());
		singlePlayerButton.addClickHandler(new ClickHandler() {
			@Override
			public void onClick(ClickEvent event) {
				clickSinglePlayerButton();
			}

		});
		removeMatchButton.setText(messages.removeMatch());
		removeMatchButton.addClickHandler(new ClickHandler() {
			@Override
			public void onClick(ClickEvent event) {
				clickRemoveMatchButton();
			}

		});
		autoMatchButton.setText(messages.autoMatchStart());
		autoMatchButton.addClickHandler(new ClickHandler() {
			@Override
			public void onClick(ClickEvent event) {
				clickAutoMatchButton();
			}

		});
		connectButton.addClickHandler(new ClickHandler() {
			@Override
			public void onClick(ClickEvent event) {
				clickConnect();
			}

		});
		matchListBox.addItem(messages.selectMatch());
		matchListBox.addChangeHandler(new ChangeHandler() {

			@Override
			public void onChange(ChangeEvent event) {
				String matchID = matchListBox.getValue(matchListBox.getSelectedIndex());
				loadBoard(matchID);
			}

		});
		// Check login status using login service.
		LoginServiceAsync loginService = GWT.create(LoginService.class);
		loginService.login(GWT.getHostPageBaseURL() + "shihweihuang.html",
				new AsyncCallback<LoginInfo>() {

					public void onFailure(Throwable error) {
					}

					public void onSuccess(LoginInfo result) {
						loginInfo = result;

						if (loginInfo.isLoggedIn()) {
							setupChannel();

							chessPlatformService.getMatchList(loginInfo,
									new AsyncCallback<Set<String>>() {
										@Override
										public void onSuccess(Set<String> matchList) {
											for (String matchID : matchList) {
												matchListBox.addItem(matchID);
											}
										}

										@Override
										public void onFailure(Throwable caught) {

										}
									});

							loadChess(new Match(), emptyState, Color.WHITE, true);

						} else {
							Window.Location.replace(loginInfo.getLoginUrl());
						}
					}
				});

	}

	protected void clickSinglePlayerButton() {
		Color color = Math.random() < 0.5 ? Color.WHITE: Color.BLACK;
		loadChess(new Match(), new State(), Color.WHITE, true);
		
	}

	private void openChannel(String token) {
		Channel channel = new ChannelFactoryImpl().createChannel(token);
		socket = channel.open(new SocketListener() {
			@Override
			public void onOpen() {
				isConnect = true;
				// Window.alert(messages.connectToSever());

			}

			@Override
			public void onMessage(String message) {
				processMessage(message);
			}

			@Override
			public void onError(ChannelError error) {

			}

			@Override
			public void onClose() {

			}
		});

	}

	private void loadChess(Match match, State state, Color color,
			boolean isSinglePlayer) {
		if (messages.language().equals("English")) {
			languageSelector.setHref(GWT.getHostPageBaseURL()
					+ "shihweihuang.html?locale=en");
		} else {
			languageSelector.setHref(GWT.getHostPageBaseURL()
					+ "shihweihuang.html?locale=tw");
		}
		RootPanel.get().clear();
		presenter = new Presenter();
		final Graphics graphics = new Graphics(presenter);
		presenter.setView(graphics);
		RootPanel.get().add(languageSelector);
		RootPanel.get().add(singlePlayerButton);
		RootPanel.get().add(graphics);
		RootPanel.get().add(matchPanel);
		if (loginInfo.isLoggedIn()) {
			RootPanel.get().add(connectPanel);
		}

		presenter.setChessPlatformService(chessPlatformService);
		presenter.setMessages(messages);
		presenter.setLoginInfo(loginInfo);
		presenter.setMatchID(match.getMatchID());
		presenter.setRanking(ranking);
		presenter.setStartDate(match.getStartDate());
		presenter.setColor(color);
		presenter.setState(state);
		presenter.setSinglePlayer(isSinglePlayer);
		presenter.setState();
		presenter.addHandlers();

		if (loginInfo.isLoggedIn()) {
			presenter.setLogin(messages.signOut(), loginInfo.getLogoutUrl());
		} else {
			presenter.setLogin(messages.signIn(), loginInfo.getLoginUrl());
		}

	}

	private void setupChannel() {

		if (chessPlatformService == null) {
			chessPlatformService = GWT.create(ChessPlatformService.class);
		}

		AsyncCallback<String> callback = new AsyncCallback<String>() {
			@Override
			public void onSuccess(String result) {
				while (socket == null) {
					openChannel(result);
				}
			}

			@Override
			public void onFailure(Throwable caught) {

			}
		};
		chessPlatformService.getToken(loginInfo, callback);

	}

	private void processMessage(String message) {

		if (message.contains("NEWMATCH")) {
			String matchID = message.substring(message.indexOf(":") + 1);
			matchListBox.addItem(matchID);
			presenter.printLog(messages.newMatch(matchID));
			autoMatchButton.setText(messages.autoMatchStart());
			matchRequestName.setText("");
		}
		if (message.contains("NEWMOVEON")) {
			String[] matchInfo = message.split("@@");
			String matchID = matchInfo[1];
			State state = StateParser.parse(matchInfo[2]);
			String currentMatchID = presenter.getMatchID();
			if (matchID.equals(currentMatchID)) {
				presenter.setState(state);
				presenter.setState();
			} else {
				presenter.printLog(messages.newMoveOn(matchID));
			}
		}
	}

	private void loadBoard(final String matchID) {

		chessPlatformService.getMatch(matchID, new AsyncCallback<Match>() {

			@Override
			public void onSuccess(Match match) {
				String stateString = match.getState();
				State state = StateParser.parse(stateString);
				Color playerColor;
				if (match.getwPlayer().equals(loginInfo.getEmailAddress())) {
					playerColor = Color.WHITE;
				} else {
					playerColor = Color.BLACK;
				}
				loadChess(match, state, playerColor, false);

			}

			@Override
			public void onFailure(Throwable caught) {
				Window.alert(caught.getMessage());
			}
		});
	}

	private void clickRemoveMatchButton() {
		String matchID = matchListBox.getItemText(matchListBox.getSelectedIndex());
		matchListBox.removeItem(matchListBox.getSelectedIndex());
		chessPlatformService.removeMatch(loginInfo, matchID,
				new AsyncCallback<Void>() {

					@Override
					public void onSuccess(Void result) {
						Window.alert(messages.matchRemoved());
					}

					@Override
					public void onFailure(Throwable caught) {

					}
				});
	}

	private void clickConnect() {
		chessPlatformService.matchPlayer(loginInfo, matchRequestName.getText(),
				new AsyncCallback<Void>() {

					@Override
					public void onSuccess(Void result) {

					}

					@Override
					public void onFailure(Throwable caught) {

					}
				});
	}

	private void clickAutoMatchButton() {
		if (autoMatchButton.getText().equals(messages.autoMatchStart())) {
			autoMatchButton.setText(messages.autoMatchStop());
			matchRequestName.setText(messages.searching());
			chessPlatformService.matchPlayer(loginInfo, "",
					new AsyncCallback<Void>() {

						@Override
						public void onSuccess(Void result) {

						}

						@Override
						public void onFailure(Throwable caught) {

						}
					});
		} else {
			autoMatchButton.setText(messages.autoMatchStart());
			matchRequestName.setText("");
			chessPlatformService.removeFromWaitList(loginInfo,
					new AsyncCallback<Void>() {

						@Override
						public void onSuccess(Void result) {

						}

						@Override
						public void onFailure(Throwable caught) {

						}
					});
		}
	}
}

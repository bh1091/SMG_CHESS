package org.wenjiechen.hw3;

import com.google.gwt.core.client.EntryPoint;
import com.google.gwt.core.client.GWT;
import com.google.gwt.user.client.History;
import com.google.gwt.user.client.Window;
import com.google.gwt.user.client.rpc.AsyncCallback;
import com.google.gwt.user.client.ui.Anchor;
import com.google.gwt.user.client.ui.Label;
import com.google.gwt.user.client.ui.RootPanel;
import com.google.gwt.user.client.ui.VerticalPanel;

import org.shared.chess.State;
import org.wenjiechen.hw6.client.ChessGameService;
import org.wenjiechen.hw6.client.ChessGameServiceAsync;
import org.wenjiechen.hw6.client.LoginInfo;
import org.wenjiechen.hw6.client.LoginService;
import org.wenjiechen.hw6.client.LoginServiceAsync;

public class ChessEntryPoint implements EntryPoint {

	private LoginInfo loginInfo = null;
	private VerticalPanel loginPanel = new VerticalPanel();
	private Label loginLabel = new Label(
			"Use your Google Account to sign in the Chess Game by wenjie chen.");
	private Anchor signInLink = new Anchor("Sign In");

	@Override
	public void onModuleLoad() {
		LoginServiceAsync loginService = GWT.create(LoginService.class);
		loginService.login(GWT.getHostPageBaseURL()+ "wenjiechen.html",
				new AsyncCallback<LoginInfo>() {
					@Override
					public void onFailure(Throwable error) {
						Window.alert("Login page failure!");
					}

					@Override
					public void onSuccess(LoginInfo result) {
//						Window.alert("Login page success!");
						loginInfo = result;
						if (loginInfo.isLoggedIn()) {
							loadModule();
						} else {
							loadLogin();
						}
					}
				});
	}

	private void loadModule() {
		final Graphics graphics = new Graphics();
		Presenter presenter = new Presenter();
		presenter.setView(graphics);
		graphics.setPresenter(presenter);
		graphics.setLogoutURL(loginInfo.getLogoutUrl());
		RootPanel.get().add(graphics);
		
		State state;
		if (History.getToken().isEmpty()) {
			state = new State();
		} else {
			state = HistoryCoder.decodingHistoryString(History.getToken());
		}

		presenter.viewBinder();
		presenter.setState(state);
	}

	private void loadLogin() {
		// Assemble login panel.
//		System.out.println("loadModule(): loadLogin");
		signInLink.setHref(loginInfo.getLoginUrl());
		loginPanel.add(loginLabel);
		loginPanel.add(signInLink);
		RootPanel.get().add(loginPanel);
	}
	
}